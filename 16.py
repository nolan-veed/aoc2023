import copy

s = r"""\.........|......./...|........................................................|............|-...\...-/.......
.....................\.......\........./...|...............|...\................................-...|.......\.
.......................................-....-./............/.......-.............\..|.......|......//.........
...../..../.....\.........-.........-./..-.......\./..\.............-.....\..........|-..................|....
...........\..\...............-.............|.......-.\......\...\..........\.......-.....|..................\
................|.........|........|............--........./\....|-.....................................-.....
........./...........\................../...................\././........./...-...-.\.-.........-.............
......|.....|............-............./...|...................-...|........./............/......./...........
......./........../..|.....-...........\|.................................................\.........|..../....
........................|..................|.......|.................-..\...........-/.\.................\.|..
.......|...|./....................................-...\........\.......|............................|...|.....
\..-................................\.......\........../....|.....................|........\../.........../..\
....-|...............................\....|..............\.....................|.....\......\............../..
.....\......-.........-.\.|..........|...............-.................|..........-............../............
.........-...................-.............................................-.........../...................|.-
....................\..\........|-.\...............-............/....|..................../...................
.\.........-........................|..-.......|.......-...........-.-...................\/...\....|....\.....
.-........-./.....-.....\.......-..........\..-........\..-.....................................\..../...|....
....-.........................|..\.....................................\./...............-............/.......
..........|..\....-........./..............................|........................-.......|./|........\.....
..\.........|..|..-|........\...-................|/..\......../.......-|..................||.-./..............
.--..-.......-........./.................\....../.................-............................--.........-...
.......|.........../......./........../..\.........\...\../..\..././.......-..................................
.........-/...............|..\|.................\...........|............../............\.....................
..........-.........\.-................|-..................../......../...|/...\..-....|-........-.......-....
.--|.\|.......|.....-............................|.-....-...|...................|........../..................
.....-......./..../.|...................|\..-.........../...|.............................\/../........../....
......./........|.\......-../...........\........................./..........\.........-...\................|.
./.......................\........-......|...|............................/............\....-.....|..../...\..
....................-..............-..-.............../..\...../.\.........\................../.....\.....-...
...................../......-....-.......|....|......../..|-...............\..\../.-.....././..........|......
..\.....|...\............................./.../...../..../......../...........................................
./.../................................../.....-.........|.....|..........-...............................-....
...............|..\...-................................\.........................|....\...............-.-.....
/........|.......|.....-.......-..-..-.\.................................-.\...-.......\.............-..\.....
./......|../......|................................/.........||.-....................|..\.........-....|../...
|..................................................\......|...-............................../.......-........
....../...............-....-..................\....-../................................./.\.................-.
......-...........-...../.....-......|..........\.\...-......../......\................--..............-......
.............\/........|...../...........-.......\...|........................................................
...\\........\..........|...\............/........-..../....-.....................-......................../..
.......-......../......./..........-....|....-..\.........................\.............../..........-.....-..
.....|\/..../.........|.........../|.....\.......-........-............../..././.............|................
.........|....|....\..-....../............/.....\/....|.............\........................|.........-......
.\\..........................//......................\....\...........................-.|/....................
...................|...................-.|........................................../..........\..............
......\..|....../...........\.-.........-.......-..|../........../.............................../.......-...|
..........|................/|.....-.....\................||........./.............|.........../..-..|./.......
............../../|.......\...............-..../|..../-..|................................../......-....|..|..
............\...............\.........................\....-.............-..|/.....--...................-...-.
.....|\......\...........................-.................-.......\...............|............|........../..
.....\...-.............|............\........\...../.-...........|.-.................\.........|..............
......./......\..-............|..-...\......................\..........|....../..........|........./.......\.-
..-.....|........./|............./.....................|...|.\....-.......-..........|...\.\|-........\....|..
......................../............-...........|...................../............-.......\.........-.......
......../..............-./...................................--........................\....-.......-..//.....
........|.....-....................|...../..............-..........-......|..\................................
.......-..//.............../.....-......................./..|........./...........-..../..|.........-.........
.-...............-...........................\.......\...........-..................-.|...\..\.....\..\.....\.
.........-../............|......|.|.........................\.......-......\...\..............-../.../-\......
.-...........-..|.....\/........-.|...................../.|........-...........\..........\.....\/|..../...\.\
.-..........\.\-..\....-\/................./.\.......|.........................-............./....\........./.
.............\.........|............/...........\\................./..-..........................|//.......\..
..../-........-.........................-\...........|................./..........|.............|.\..|........
...-..|.....\..-..\.................\-.................|...../.-..........|........|/...-.-.\.................
.-.-............................|.....\..-..........|/|.........|....\............\.....\..-...........|/...|.
......................../...............|..-............................-.........|........../.-....../.......
.........|-...................|.....................-...........|.../..............................|....-...-.
..............|....................................................|.....|.......--.....\...\.............../.
..-...............|........|..................-............|.........../.....\................................
........................|.........|............-....-..\../..................\..|......\.........\../.../.....
.|............................./..............-....-.......--....-.../..........|.....\.........-/.....|-./...
....-..............|...-.....\.....\/.-........................................-.\.............|...../|/......
........./..-................/........./..............-............................................-....-.....
...........-........./...................../.........-........-................./.|...........................
............................................................-.............-..-......|..........-.\............
....\/........................-../.../.................................\............/..........|./-......-...\
....-............../..-.\.......|......-...|...|.........../......|../...........|..-.\.................../...
...-......../....-........................|...-............-.........................|/.....|.........|......-
...|........-.......-.......|...|\.......\............-...-...................................-|........-.....
....\/..-.....-.....-..--./-..-............../................|............\.............../.......|..........
.........-.\.......-......|........-.............|..../..............\-.....\..........-..../.................
.................-......\|.--..../../.-......-.......-........\....-...../....................../.............
...../..../....../.............-......\..........|..........\..\........-.-...................................
..............................|........./........-..................|.............-.../.................\..-..
.....|./......-........\...\.................|....-........|..............|...................................
\...|............................-..|.............../..............|.../......-......-.........../....../.....
..../.............................-..........\.....\-..................................-........../...........
..........................\....................-...-/.|....................../................................
\.......|.........-............\\...............-...-...................../...................................
..\...................................-................................................../.......\.|..........
...............................-................/........\....\.......|...................-.../.....|.........
...-..-............-.||..../././..........-\\............||...............-.\.........../...\........|...\...|
....\./.|./...................\..-.-./..-.....||............../............|.......\.|...../..................
......-.......\.\.........\......|..\...\.-|.\..............|...|......\......./...\........................-.
........./.-......../....|..............................|...|...\........//./.................................
.........................|...........\...........|.....................\........//..-.................\-/.....
.\....................\..-.-..-..........|/.\..........\././.....................|............\....|...|/.....
......./.................../...-.................\.........../.........\................|....................|
......-..\....|..................\............\........|......|....../........................................
.........\/..............|.............\.........-............-...........\.\..\./....../.....//..............
.........../...\.......-.../.-.............\../....\|./............/...-..\........|..|/.....\......\\........
..|............/..............................................-./...-.|..........-......../...................
...............-..|.......\.............\..../.....................|..........\...................\.....\./\..
.|..........\..\...|......................\...........-.......--........................-.....................
...................../................\.|..........-..|................-................................-.....
...../.........|-............|.\.|.../\.....|../........\../..................................................
................/........\../.....................\./..../...........-............\-......../../..\.|.........
..............|.........-......|/......././.....|..../.|...........-.....................|./.-.....\...|......
.......|..-.......\..........|................................................/..\.....-..........-..........."""

s2 = r""".|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|...."""

grid = s.splitlines()
zeroes = [0 for _ in range(len(grid[0]))]
energised_grid = [zeroes.copy() for _ in range(len(grid))]


def reset_energised_grid():
    global energised_grid
    energised_grid = [zeroes.copy() for _ in range(len(grid))]


# right, down, left, up
dirs = [(0, 1), (1, 0), (0, -1), (-1, 0)]

mappings = {
    0: {
        '-': [0],
        '|': [1, 3],
        '/': [3],
        '\\': [1],
    },
    1: {
        '-': [0, 2],
        '|': [1],
        '/': [2],
        '\\': [0],
    },
    2: {
        '-': [2],
        '|': [1, 3],
        '/': [1],
        '\\': [3],
    },
    3: {
        '-': [0, 2],
        '|': [3],
        '/': [0],
        '\\': [2],
    },
}


def energize(r, c, dir):
    flags = [1, 2, 4, 8]
    flag = flags[dir]

    v = energised_grid[r][c]
    if v & flag > 0:
        return False
    energised_grid[r][c] = v | flag
    return True


def traverse(r, c, dir):
    if not 0 <= r < len(grid):
        return
    if not 0 <= c < len(grid[0]):
        return
    energised = energize(r, c, dir)
    if not energised:
        return
    ch = grid[r][c]
    if ch == '.':
        i_r, i_c = dirs[dir]
        new_r, new_c = r + i_r, c + i_c
        traverse(new_r, new_c, dir)
    else:
        mapping = mappings[dir]
        new_dirs = mapping[ch]
        for new_dir in new_dirs:
            i_r, i_c = dirs[new_dir]
            new_r, new_c = r + i_r, c + i_c
            traverse(new_r, new_c, new_dir)


def traverse2(start_r, start_c, start_dir):
    stack = [(start_r, start_c, start_dir)]
    while True:
        if len(stack) == 0:
            return
        r, c, dir = stack.pop()

        if not 0 <= r < len(grid):
            continue
        if not 0 <= c < len(grid[0]):
            continue
        energised = energize(r, c, dir)
        if not energised:
            continue
        ch = grid[r][c]
        if ch == '.':
            i_r, i_c = dirs[dir]
            new_r, new_c = r + i_r, c + i_c
            stack.append((new_r, new_c, dir))
        else:
            mapping = mappings[dir]
            new_dirs = mapping[ch]
            for new_dir in new_dirs:
                i_r, i_c = dirs[new_dir]
                new_r, new_c = r + i_r, c + i_c
                stack.append((new_r, new_c, new_dir))


def count_energised():
    count = 0
    for r in range(len(energised_grid)):
        for c in range(len(energised_grid[0])):
            if energised_grid[r][c] > 0:
                count += 1
    return count


def part1():
    reset_energised_grid()
    traverse2(0, 0, 0)
    count = count_energised()
    print(count)  # 7728


# part1()

def part2_run(r, c, dir):
    reset_energised_grid()
    traverse2(r, c, dir)
    count = count_energised()
    # print(count)
    return count


def part2():
    max_count = 0
    for c in range(len(grid[0])):
        count = part2_run(0, c, 1)
        max_count = max(max_count, count)
        count = part2_run(len(grid) - 1, c, 3)
        max_count = max(max_count, count)

    print(max_count)

    for r in range(len(grid)):
        count = part2_run(r, 0, 0)
        max_count = max(max_count, count)
        count = part2_run(r, len(grid[0]) - 1, 2)
        max_count = max(max_count, count)

    print(max_count)


part2()
